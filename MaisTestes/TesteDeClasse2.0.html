<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Semana4</title>
    <script src="./Sprite2.0.js"></script>
    <script src="./Scene.js"></script>
    <script src="./AssetsManager.js"></script>
</head>
<body>
    <canvas></canvas>
    <script>
        var AssetsMng = new AssetsManager();

        AssetsMng.loadImage("player","boss1.png");

        AssetsMng.loadImage("enemy_1","enemy_1.png");

        var imgPlayer = new Image();
        imgPlayer.src = "player_ship.png"
        imgPlayer.addEventListener("load",function(){
            console.log("imagem player carreganda!");
        })
        console.log("Carregando imagem player...");
        imgPlayer.src = "player_ship.png"
         
        var canvas = document.querySelector("canvas");
        var ctx = canvas.getContext("2d")

        canvas.width = 600;
        canvas.height = 480;

        var teclas = {
            esquerda: 0,
            cima: 0,
            direita: 0,
            baixo: 0,
            espace: 0,
        }
    
        var cena1 = new Scene({ctx: ctx, w: canvas.width , h: canvas.height,assets: AssetsMng });
        var personagem = new Sprite({x:150 ,y:150 ,w:128,h:128,comportar: porTeclasDirecionais(teclas), props:{tipo:"pernsonagem"}});
        var dt ,anterior = 0;

        cena1.adicionar(personagem);
        cena1.adicionar(new Sprite({ x: 460, y: 150, w: 32,h: 32, va:2, vm:30, color: "green", comportar: persegueSpawn(personagem), props:{tipo:"npc", spawn:0}, desenhar:desenhaPersonagem }));
        for (var k = 0; k < 10; k++) {
          
            cena1.adicionar(new Sprite({
                x: 300*Math.random(), 
                y: 400*Math.random(), 
                h: 32,
                w: 32, 
                va:2*Math.random(), 
                vm:60*Math.random(),
                color: "red",
                comportar: persegue2(personagem) ,
                props:{tipo:"npc"},
                desenhar: desenhaInimigo,
            }));
            
        }

        /*function persegue(alvo) {
            return function(){
            this.vx = 20*Math.sign(alvo.x - this.x);
            this.vy = 20*Math.sign(alvo.y - this.y);
            }
        }*/

        function desenhaPersonagem(){
        ctx.save();
    ctx.translate(this.x,this.y);
    ctx.rotate(this.a+Math.PI/2);
    ctx.drawImage(this.scene.assets.img("player"),
    -this.w/2,
    -this.h/2,
    this.w,
    this.h)
    /*
    ctx.fillStyle = this.color;
    ctx.strokeStyle = "black";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(-this.w/2,-this.h/2);
    ctx.lineTo(-this.w/2, +this.h/2);
    ctx.lineTo(+this.w/2, 0);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();
*/
    ctx.restore();
        }

        function desenhaInimigo () {
            ctx.save();
    ctx.translate(this.x,this.y);
    ctx.rotate(this.a+Math.PI/2);
    ctx.drawImage(this.scene.assets.img("enemy_1"),
    -this.w/2,
    -this.h/2,
    this.w,
    this.h)
    /*
    ctx.fillStyle = this.color;
    ctx.strokeStyle = "black";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(-this.w/2,-this.h/2);
    ctx.lineTo(-this.w/2, +this.h/2);
    ctx.lineTo(+this.w/2, 0);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();
*/
    ctx.restore();
        }

        function persegue2(alvo) {
            return function () {
                var dx = alvo.x - this.x;
                var dy = alvo.y - this.y;
                var da = Math.sqrt(dx*dx + dy*dy);
                var adj = Math.PI/2; 
                var prod = (dx/da)*Math.cos(this.a +adj) + (dy/da)*Math.sin(this.a +adj);
                this.va = 2*(prod-0);
                //this.vm = 30;
            }
        }

        function persegueSpawn(alvo) {
            return function () {
                var dx = alvo.x - this.x;
                var dy = alvo.y - this.y;
                var da = Math.sqrt(dx*dx + dy*dy);
                var adj = 1.5; 
                var prod = (dx/da)*Math.cos(this.a +adj) +
                (dy/da)*Math.sin(this.a +adj);
                this.va = 2*(prod-0);
                this.props.spawn -= (1/20);
                if(this.props.spawn<=0){
                    this.props.spawn = 2;
                    var novo = new Sprite({
                        color : "yellow",
                        x : this.x, y: this.y,
                        h:32,
                        w: 32,
                        vm: 100*Math.random(),
                        props: {tipo: "npc"},
                        comportar: persegue2(alvo) 
                    });
                    this.scene.adicionar(novo);
                }
                //this.vm = 30;
            }
        }

        function porTeclasDirecionais(teclas) {
            return function(){
                if (teclas.esquerda){ this.va = -3}
                if (teclas.direita){ this.va = 3}
                if (!teclas.esquerda === !teclas.direita){ this.va = 0}
                if (teclas.cima){ this.vm = 300}
                if (teclas.baixo){ this.vm = -300}
                if (!teclas.baixo === !teclas.cima){ this.vm = 0}

                if (teclas.espace && this.cooldown <= 0){
                    var tiro = new Sprite({
                        x: this.x, y: this.y ,a: this.a -0.1+0.2*Math.random(), vm:240, color: "green",w: 10 , h: 10 ,props:{tipo: "tiro"}
                    })
                    this.scene.adicionar(tiro);
                    this.cooldown = 0.05;
                }
            }
        }

        addEventListener("keydown", function(e){
            switch (e.keyCode){
                case 37:
                    teclas.esquerda = 1;
                    break;
                case 39:
                    teclas.direita = 1;
                    break;
                case 38:
                    teclas.cima = 1;
                    break;
                case 40:
                    teclas.baixo = 1;
                    break;
                case 32:
                    teclas.espace = 1;
                    break;
            }
        })
        addEventListener("keyup", function(e){
            switch (e.keyCode){
                case 37:
                    teclas.esquerda = 0;
                    break;
                case 39:
                    teclas.direita = 0;
                    break;
                case 38:
                    teclas.cima = 0;
                    break;
                case 40:
                    teclas.baixo = 0;
                    break;
                case 32:
                    teclas.espace = 0;
                    break;
            }
        })


        function passo(t){
            dt = (t - anterior)/1000;
            cena1.passo(dt);
            //ctx.drawImage(AssetsMng.img("player"),cena1.sprites[0].x,cena1.sprites[0].y,256,256);
            anterior = t;
            ctx.fillText(1/dt, 10,20);
            requestAnimationFrame(passo);
        }
        requestAnimationFrame(passo);

    </script>
</body>
</html>